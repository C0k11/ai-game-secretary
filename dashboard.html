<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI Game Secretary</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 16px; background: #fafafa; color: #111; }
    .container { max-width: 1240px; margin: 0 auto; }
    .topbar { display: flex; justify-content: space-between; align-items: baseline; gap: 12px; margin-bottom: 10px; }
    .topbar h2 { margin: 0; font-size: 22px; }
    .topbar .links { display: flex; gap: 12px; font-size: 13px; }

    .card { background: #fff; border: 1px solid #e5e5e5; border-radius: 10px; padding: 12px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 10px; align-items: flex-end; }
    label { display: flex; flex-direction: column; font-size: 12px; color: #333; gap: 6px; }
    input[type=text], input[type=number] { padding: 9px 10px; min-width: 180px; border: 1px solid #ddd; border-radius: 8px; }
    .wide { min-width: 520px; flex: 1; }

    .btn { padding: 10px 14px; border-radius: 10px; border: 1px solid #ddd; background: #fff; cursor: pointer; }
    .btn:hover { background: #f7f7f7; }
    .btn.primary { background: #0b5fff; border-color: #0b5fff; color: #fff; }
    .btn.primary:hover { background: #0a55e5; }
    .btn.danger { background: #fff; border-color: #f0b4b4; color: #b00020; }
    .btn.danger:hover { background: #fff5f5; }
    .btn.ghost { background: transparent; }

    .status { display: flex; align-items: center; gap: 10px; font-size: 13px; }
    .pill { display: inline-flex; align-items: center; gap: 6px; padding: 3px 8px; border-radius: 999px; border: 1px solid #ddd; background: #f6f6f6; font-size: 12px; }
    .pill.ok { border-color: #b7e4c7; background: #ecfdf3; color: #0a7a2f; }
    .pill.bad { border-color: #f0b4b4; background: #fff5f5; color: #b00020; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }

    .logs { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 10px; }
    textarea.log { width: 100%; height: 520px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; border: 1px solid #ddd; border-radius: 10px; padding: 10px; }
    textarea#goal { width: 100%; min-height: 140px; padding: 10px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; border: 1px solid #ddd; border-radius: 10px; }
    details > summary { cursor: pointer; user-select: none; }
    .muted { color: #666; }
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <h2>AI Game Secretary</h2>
      <div class="links">
        <a href="/annotate.html">Annotate</a>
        <a href="/docs" class="muted" target="_blank" rel="noreferrer">API Docs</a>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <label>Window Title
          <input id="window_title" type="text" value="Blue Archive" />
        </label>
        <label>Steps (0=loop)
          <input id="steps" type="number" value="0" />
        </label>
        <label>Step Sleep (s)
          <input id="step_sleep_s" type="number" value="0.6" />
        </label>
        <label>VLM Max Side (0=off)
          <input id="vlm_image_max_side" type="number" value="1280" />
        </label>
      </div>

      <div class="row">
        <label class="wide">Goal
          <textarea id="goal">Keep the game running safely.</textarea>
        </label>
      </div>

      <div class="row">
        <label style="flex-direction:row; gap:8px; align-items:center; font-size:13px;">
          <input id="dry_run" type="checkbox" checked /> Dry Run
        </label>
        <label style="flex-direction:row; gap:8px; align-items:center; font-size:13px;">
          <input id="forbid_premium_currency" type="checkbox" checked /> Forbid Premium Currency
        </label>
        <label style="flex-direction:row; gap:8px; align-items:center; font-size:13px;">
          <input id="exploration_click" type="checkbox" /> Exploration Click
        </label>

        <button id="btn_start" class="btn primary">Start</button>
        <button id="btn_stop" class="btn danger">Stop</button>
        <button id="btn_refresh" class="btn">Refresh</button>
        <button id="btn_clear" class="btn ghost">Clear View</button>
      </div>

      <div class="row" style="margin-top: 2px;">
        <span class="muted" style="font-size: 12px;">Presets:</span>
        <button id="btn_preset_dryrun" class="btn">DryRun 80</button>
        <button id="btn_preset_real" class="btn">Real Loop</button>
        <button id="btn_goal_daily" class="btn">Daily Routine Template</button>
      </div>

      <div class="status" id="status">
        <span class="pill" id="status_pill">Unknown</span>
        <span class="mono" id="status_text">Status: ...</span>
      </div>

      <div id="routineHud" style="display: none; margin-top: 10px; padding: 10px; border-radius: 8px; background-color: #f0f9ff; border: 1px solid #bae6fd;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
          <span style="font-weight: bold; font-size: 1.1em;" id="routinePhase">Idle</span>
          <span id="routineBadge" style="background: #0ea5e9; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em;">Normal</span>
        </div>

        <div style="width: 100%; background-color: #e0e0e0; height: 8px; border-radius: 4px; margin-bottom: 5px;">
          <div id="routineProgressBar" style="width: 0%; height: 100%; background-color: #0ea5e9; border-radius: 4px; transition: width 0.3s;"></div>
        </div>

        <div style="font-size: 0.85em; color: #555; display: flex; justify-content: space-between;">
          <span id="routineStepInfo">Step 0/0</span>
          <span id="routineTurnInfo">Turns: 0/15</span>
        </div>
        <div id="routineRetryInfo" style="font-size: 0.85em; color: #d97706; display: none; margin-top: 2px;">
          Retrying (0/0)
        </div>
      </div>
    </div>

    <details open style="margin-top: 12px;">
      <summary class="muted">Logs</summary>
      <div class="logs">
        <div>
          <div><b>agent.out.log</b></div>
          <textarea id="agent_out" class="log" readonly></textarea>
        </div>
        <div>
          <div><b>agent.err.log</b></div>
          <textarea id="agent_err" class="log" readonly></textarea>
        </div>
      </div>
    </details>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    const STORAGE_KEY = 'ai_game_secretary.dashboard.v1';

    function loadSaved() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const s = JSON.parse(raw);
        if (typeof s.window_title === 'string') $('window_title').value = s.window_title;
        if (typeof s.goal === 'string') $('goal').value = s.goal;
        if (typeof s.steps === 'number') $('steps').value = String(s.steps);
        if (typeof s.step_sleep_s === 'number') $('step_sleep_s').value = String(s.step_sleep_s);
        const uiRev = (typeof s._ui_rev === 'number') ? s._ui_rev : 0;
        if (uiRev >= 2 && typeof s.vlm_image_max_side === 'number') {
          $('vlm_image_max_side').value = String(s.vlm_image_max_side);
        } else {
          $('vlm_image_max_side').value = '0';
        }
        if (typeof s.dry_run === 'boolean') $('dry_run').checked = s.dry_run;
        if (typeof s.forbid_premium_currency === 'boolean') $('forbid_premium_currency').checked = s.forbid_premium_currency;
        if (typeof s.exploration_click === 'boolean') $('exploration_click').checked = s.exploration_click;
      } catch (e) {}
    }

    function saveNow() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(payload()));
      } catch (e) {}
    }

    const DAILY_ROUTINE_TEMPLATE = `[Routine]\n【目标】蔚蓝档案：日常收菜（排除总力战/大决战/制约解除决战）

【总原则】
- 先判断当前界面是什么（大厅/二级菜单/弹窗），优先关闭公告/签到等阻挡弹窗。
- 优先处理红点/可领取/确认/开始/进入/跳过/一键领取等“安全按钮”。
- 绝对不要点击：总力战/大决战/制约解除决战（即使有红点也忽略）。
- 绝对不要点击：充值/购买/招募/抽卡/青辉石/清輝石/Pyroxene 相关。

【流程（状态机）】
1) 大厅：处理弹窗 -> 观察咖啡厅/日程/社团/业务区红点
2) 咖啡厅：领取收益 -> 依次点击所有黄色感叹号/对话气泡角色 -> 返回大厅
3) 日程：优先点红点且Rank较高/最优的区域 -> 确认 -> 返回
4) 社团：领取AP -> 返回
5) 悬赏通缉：有票就选最高难度 -> 扫荡 -> Max -> 确认 -> 返回
6) 战术对抗赛：仅领奖；如需要日课则打一场（进场后优先点跳过）-> 返回
7) 清体力：活动期优先活动扫荡；否则主线/Hard收藏关卡扫荡到体力不足
8) 制造：领取完成品 -> 有空位就制造 -> 确认 -> 返回
9) 邮箱&任务：一键领取 -> 确认 -> 返回

【异常处理】
- 如果不确定/界面识别失败：先 wait；必要时点击“返回/关闭/X/空白安全区域”尝试回到大厅。`;

    async function api(path, opts) {
      const r = await fetch(path, opts);
      if (!r.ok) {
        const t = await r.text();
        throw new Error(`${r.status} ${r.statusText}: ${t}`);
      }
      const ct = r.headers.get('content-type') || '';
      if (ct.includes('application/json')) return await r.json();
      return await r.text();
    }

    function payload() {
      return {
        _ui_rev: 2,
        window_title: $('window_title').value.trim(),
        goal: $('goal').value.trim(),
        steps: parseInt($('steps').value, 10) || 0,
        step_sleep_s: parseFloat($('step_sleep_s').value) || 0.6,
        vlm_image_max_side: parseInt($('vlm_image_max_side').value, 10) || 0,
        dry_run: $('dry_run').checked,
        forbid_premium_currency: $('forbid_premium_currency').checked,
        exploration_click: $('exploration_click').checked,
      };
    }

    async function refresh() {
      try {
        const st = await api('/api/v1/status');
        const out = await api('/api/v1/logs?name=agent.out.log&lines=400');
        const err = await api('/api/v1/logs?name=agent.err.log&lines=400');
        $('agent_out').value = out;
        $('agent_err').value = err;
        const la = st.last_action ? JSON.stringify(st.last_action).slice(0, 300) : '';
        const le = st.last_error ? String(st.last_error).slice(0, 300) : '';
        const ok = Boolean(st.agent_running) && !le;
        $('status_pill').className = 'pill ' + (ok ? 'ok' : 'bad');
        $('status_pill').textContent = ok ? 'Running' : (st.agent_running ? 'Error' : 'Stopped');
        let cfgStr = '';
        try {
          const cfg = st.agent_cfg || null;
          if (cfg) {
            const g = (typeof cfg.goal === 'string') ? cfg.goal.replace(/\s+/g, ' ').slice(0, 140) : '';
            cfgStr = ` cfg.goal=${g} cfg.steps=${cfg.steps} cfg.dry_run=${cfg.dry_run} cfg.vlm_image_max_side=${cfg.vlm_image_max_side}`;
          }
        } catch (e) {
        }
        $('status_text').textContent = `agent_running=${st.agent_running} type=${st.agent_type || ''} last_error=${le} last_action=${la}${cfgStr}`;

        try {
          const hud = $('routineHud');
          const r = st.last_action && st.last_action._routine ? st.last_action._routine : null;
          const active = Boolean(r && r.active);

          if (!active) {
            hud.style.display = 'none';
          } else {
            hud.style.display = 'block';
            const badge = $('routineBadge');
            const progressBar = $('routineProgressBar');
            const retryDiv = $('routineRetryInfo');

            $('routinePhase').textContent = String(r.step_name || 'Unknown');

            const totalSteps = (typeof r.total_steps === 'number' && r.total_steps > 0) ? r.total_steps : 6;
            const stepIndex = (typeof r.step_index === 'number' && r.step_index >= 0) ? r.step_index : 0;
            const progressPct = ((stepIndex + 1) / totalSteps) * 100;
            progressBar.style.width = `${Math.min(Math.max(progressPct, 0), 100)}%`;
            $('routineStepInfo').textContent = `Step ${stepIndex + 1}/${totalSteps}`;

            const maxTurns = (typeof r.max_turns_per_attempt === 'number' && r.max_turns_per_attempt > 0) ? r.max_turns_per_attempt : 15;
            const turns = (typeof r.turns_in_current_attempt === 'number' && r.turns_in_current_attempt >= 0) ? r.turns_in_current_attempt : 0;
            $('routineTurnInfo').textContent = `Turns: ${turns}/${maxTurns}`;

            const inRecovery = Boolean(r.in_recovery_mode);
            if (inRecovery) {
              badge.textContent = 'RECOVERY MODE';
              badge.style.backgroundColor = '#ef4444';
              hud.style.backgroundColor = '#fef2f2';
              hud.style.borderColor = '#fca5a5';
              progressBar.style.backgroundColor = '#ef4444';
            } else {
              badge.textContent = 'Normal';
              badge.style.backgroundColor = '#0ea5e9';
              hud.style.backgroundColor = '#f0f9ff';
              hud.style.borderColor = '#bae6fd';
              progressBar.style.backgroundColor = '#0ea5e9';
            }

            const rc = (typeof r.current_step_retry_count === 'number') ? r.current_step_retry_count : 0;
            const mr = (typeof r.max_retries === 'number' && r.max_retries >= 0) ? r.max_retries : 0;
            if (rc > 0 && !inRecovery) {
              retryDiv.style.display = 'block';
              retryDiv.textContent = `⚠️ Retrying Step (${rc}/${mr})`;
            } else {
              retryDiv.style.display = 'none';
            }
          }
        } catch (e) {
        }
      } catch (e) {
        $('status_pill').className = 'pill bad';
        $('status_pill').textContent = 'Offline';
        $('status_text').textContent = 'Status: ' + e.message;
      }
    }

    $('btn_start').onclick = async () => {
      $('status_pill').className = 'pill';
      $('status_pill').textContent = 'Starting';
      $('status_text').textContent = 'Status: starting...';
      try {
        saveNow();
        await api('/api/v1/start', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload())});
      } catch (e) {
        $('status_pill').className = 'pill bad';
        $('status_pill').textContent = 'Start failed';
        $('status_text').textContent = 'Status: start failed: ' + e.message;
      }
      await refresh();
    };

    $('btn_stop').onclick = async () => {
      try {
        await api('/api/v1/stop', { method: 'POST' });
      } catch (e) {
        $('status_pill').className = 'pill bad';
        $('status_pill').textContent = 'Stop failed';
        $('status_text').textContent = 'Status: stop failed: ' + e.message;
      }
      await refresh();
    };

    $('btn_refresh').onclick = refresh;

    $('btn_clear').onclick = () => {
      $('agent_out').value = '';
      $('agent_err').value = '';
    };

    $('btn_preset_dryrun').onclick = () => {
      $('steps').value = '80';
      $('dry_run').checked = true;
      $('forbid_premium_currency').checked = true;
      $('exploration_click').checked = true;
      $('vlm_image_max_side').value = '1280';
      saveNow();
    };

    $('btn_preset_real').onclick = () => {
      $('steps').value = '0';
      $('dry_run').checked = false;
      $('forbid_premium_currency').checked = true;
      $('exploration_click').checked = true;
      $('vlm_image_max_side').value = '1280';
      saveNow();
    };

    $('btn_goal_daily').onclick = () => {
      $('goal').value = DAILY_ROUTINE_TEMPLATE;
      saveNow();
    };

    ['window_title', 'steps', 'step_sleep_s', 'vlm_image_max_side', 'goal', 'dry_run', 'forbid_premium_currency', 'exploration_click'].forEach((id) => {
      const el = $(id);
      if (!el) return;
      el.addEventListener('change', saveNow);
      el.addEventListener('input', () => {
        if (id === 'goal') saveNow();
      });
    });

    loadSaved();
    setInterval(refresh, 1200);
    refresh();
  </script>
</body>
</html>
