<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI Game Secretary</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 16px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 10px; }
    label { display: flex; flex-direction: column; font-size: 12px; color: #333; }
    input[type=text], input[type=number] { padding: 8px; min-width: 180px; }
    .wide { min-width: 520px; flex: 1; }
    button { padding: 10px 14px; }
    .logs { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px; }
    textarea { width: 100%; height: 520px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; }
    .status { padding: 8px 10px; background: #f5f5f5; border: 1px solid #ddd; margin-top: 10px; }
  </style>
</head>
<body>
  <h2>AI Game Secretary</h2>

  <div class="row">
    <a href="/annotate.html">Annotate (click text to save labels)</a>
  </div>

  <div class="row">
    <label>LLM Host
      <input id="llm_host" type="text" value="127.0.0.1" />
    </label>
    <label>LLM Port
      <input id="llm_port" type="number" value="11434" />
    </label>
    <label class="wide">Model Tag (Ollama)
      <input id="model_tag" type="text" value="qwen2.5:14b-instruct" />
    </label>
  </div>

  <div class="row">
    <label class="wide">OLLAMA_MODELS
      <input id="ollama_models_dir" type="text" value="D:\\Project\\ml_cache\\models" />
    </label>
  </div>

  <div class="row">
    <label>ADB Serial
      <input id="adb_serial" type="text" placeholder="(optional)" />
    </label>
    <label>Steps (0=loop)
      <input id="steps" type="number" value="0" />
    </label>
    <label class="wide">OD Queries (comma)
      <input id="od_queries" type="text" value="Start,Skip,Next,Battle,Event" />
    </label>
  </div>

  <div class="row">
    <label>
      <span> </span>
      <label style="flex-direction:row; gap:8px; align-items:center; font-size:13px;">
        <input id="start_local_llm" type="checkbox" checked /> Start Local LLM (Ollama)
      </label>
    </label>
    <label>
      <span> </span>
      <label style="flex-direction:row; gap:8px; align-items:center; font-size:13px;">
        <input id="auto_pull" type="checkbox" /> Auto Pull Model
      </label>
    </label>

    <button id="btn_start">Start</button>
    <button id="btn_stop">Stop</button>
    <button id="btn_refresh">Refresh</button>
  </div>

  <div class="status" id="status">Status: ...</div>

  <div class="logs">
    <div>
      <div><b>agent.out.log</b></div>
      <textarea id="agent_out" readonly></textarea>
    </div>
    <div>
      <div><b>agent.err.log</b></div>
      <textarea id="agent_err" readonly></textarea>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    async function api(path, opts) {
      const r = await fetch(path, opts);
      if (!r.ok) {
        const t = await r.text();
        throw new Error(`${r.status} ${r.statusText}: ${t}`);
      }
      const ct = r.headers.get('content-type') || '';
      if (ct.includes('application/json')) return await r.json();
      return await r.text();
    }

    function payload() {
      const od = $('od_queries').value.split(',').map(x => x.trim()).filter(Boolean);
      return {
        llm_host: $('llm_host').value.trim(),
        llm_port: parseInt($('llm_port').value, 10) || 11434,
        model_tag: $('model_tag').value.trim(),
        start_local_llm: $('start_local_llm').checked,
        auto_pull: $('auto_pull').checked,
        ollama_models_dir: $('ollama_models_dir').value.trim(),
        adb_serial: $('adb_serial').value.trim(),
        steps: parseInt($('steps').value, 10) || 0,
        od_queries: od,
      };
    }

    async function refresh() {
      try {
        const st = await api('/api/v1/status');
        const out = await api('/api/v1/logs?name=agent.out.log&lines=400');
        const err = await api('/api/v1/logs?name=agent.err.log&lines=400');
        $('agent_out').value = out;
        $('agent_err').value = err;
        $('status').textContent = `Status: ollama_listening=${st.ollama_listening} agent_running=${st.agent_running} pid=${st.agent_pid || ''}`;
      } catch (e) {
        $('status').textContent = 'Status: ' + e.message;
      }
    }

    $('btn_start').onclick = async () => {
      $('status').textContent = 'Status: starting...';
      try {
        await api('/api/v1/start', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload())});
      } catch (e) {
        $('status').textContent = 'Status: start failed: ' + e.message;
      }
      await refresh();
    };

    $('btn_stop').onclick = async () => {
      try {
        await api('/api/v1/stop', { method: 'POST' });
      } catch (e) {
        $('status').textContent = 'Status: stop failed: ' + e.message;
      }
      await refresh();
    };

    $('btn_refresh').onclick = refresh;

    setInterval(refresh, 1200);
    refresh();
  </script>
</body>
</html>
