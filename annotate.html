<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Annotate - AI Game Secretary</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 16px; }
    .top { display:flex; gap:12px; align-items:center; flex-wrap: wrap; }
    input[type=text], select { padding: 8px; min-width: 240px; }
    button { padding: 10px 14px; }
    .layout { display:grid; grid-template-columns: 340px 1fr; gap: 12px; margin-top: 12px; }
    .panel { border: 1px solid #ddd; border-radius: 8px; padding: 10px; }
    .list { height: 720px; overflow:auto; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; }
    .item { padding: 6px 8px; cursor: pointer; border-bottom: 1px solid #f1f1f1; }
    .item:hover { background:#f7f7f7; }
    .item.active { background:#e9f2ff; }
    .stage { position: relative; border: 1px solid #ddd; border-radius: 8px; overflow: auto; height: 760px; background:#111; }
    .imgwrap { position: relative; display: inline-block; }
    #img { display:block; max-width: 100%; height:auto; }
    .box { position:absolute; border: 2px solid rgba(0, 255, 120, 0.85); background: rgba(0, 255, 120, 0.08); cursor:pointer; }
    .box:hover { background: rgba(0, 255, 120, 0.18); }
    .tag { position:absolute; left:0; top:-18px; font-size: 11px; color:#0f0; background: rgba(0,0,0,0.65); padding: 1px 4px; border-radius: 4px; white-space: nowrap; }
    .status { margin-top: 10px; padding: 8px 10px; background:#f5f5f5; border:1px solid #ddd; border-radius: 8px; }
  </style>
</head>
<body>
  <div class="top">
    <a href="/dashboard.html">Back to Dashboard</a>
    <select id="session"></select>
    <button id="reload_sessions">Reload</button>
    <button id="reload_images">Reload Images</button>
    <label>Engine:
      <select id="engine">
        <option value="local_vlm">Local VLM (Transformers)</option>
      </select>
    </label>
    <label>VLM Model:
      <input id="vlm_model" type="text" value="Qwen/Qwen3-VL-8B-Instruct" readonly />
    </label>
    <label>Label to save:
      <input id="label" type="text" placeholder="e.g. goto:mail / page:home" />
    </label>
    <button id="next_unlabeled">Next Unlabeled</button>
    <button id="build_ocr_index">Build OCR Index</button>
    <label style="display:flex; align-items:center; gap:6px;">
      <input id="auto_next" type="checkbox" checked />
      Auto next after save
    </label>
    <label style="display:flex; align-items:center; gap:6px;">
      <input id="edit_text" type="checkbox" />
      Edit text before save
    </label>
  </div>

  <div class="layout">
    <div class="panel">
      <div><b>Images</b></div>
      <div class="list" id="images"></div>
    </div>

    <div class="panel">
      <div><b>Preview</b></div>
      <div class="stage" id="stage">
        <div class="imgwrap" id="imgwrap">
          <img id="img" />
        </div>
      </div>
      <div class="status" id="status">Ready</div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    async function api(path, opts) {
      const r = await fetch(path, opts);
      if (!r.ok) {
        const t = await r.text();
        throw new Error(`${r.status} ${r.statusText}: ${t}`);
      }
      const ct = r.headers.get('content-type') || '';
      if (ct.includes('application/json')) return await r.json();
      return await r.text();
    }

    let currentImage = null;
    let currentOcr = [];
    let labeledSet = new Set();
    let currentFilename = '';

    function setStatus(s) { $('status').textContent = s; }

    function clearBoxes() {
      const wrap = $('imgwrap');
      [...wrap.querySelectorAll('.box')].forEach(x => x.remove());
    }

    function addBox(box, scaleX, scaleY) {
      const wrap = $('imgwrap');
      const div = document.createElement('div');
      div.className = 'box';
      const [x1,y1,x2,y2] = box.bbox;
      div.style.left = (x1 * scaleX) + 'px';
      div.style.top = (y1 * scaleY) + 'px';
      div.style.width = ((x2-x1) * scaleX) + 'px';
      div.style.height = ((y2-y1) * scaleY) + 'px';

      const tag = document.createElement('div');
      tag.className = 'tag';
      tag.textContent = box.label;
      div.appendChild(tag);

      div.onclick = async () => {
        const label = $('label').value.trim();
        if (!label) { setStatus('Please fill "Label to save" first'); return; }

        let text = box.label;
        if ($('edit_text').checked) {
          const v = window.prompt('Edit text to save (for Traditional Chinese fixes):', text);
          if (v === null) return;
          text = (v || '').trim();
        }

        try {
          await api('/api/v1/annotations/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              image: currentImage,
              label,
              text,
              bbox: box.bbox,
              type: box.type || 'ocr'
            })
          });
          setStatus('Saved: ' + label + ' <- ' + box.label);
          await refreshAnnotationIndex();
          if ($('auto_next').checked) {
            await goNextUnlabeled();
          }
        } catch (e) {
          setStatus('Save failed: ' + e.message);
        }
      };

      wrap.appendChild(div);
    }

    async function loadSessions() {
      const sessions = await api('/api/v1/captures/sessions');
      const sel = $('session');
      sel.innerHTML = '';
      for (const s of sessions.sessions) {
        const opt = document.createElement('option');
        opt.value = s.name;
        opt.textContent = `${s.name} (${s.png_count})`;
        sel.appendChild(opt);
      }
      if (sessions.sessions.length) {
        sel.value = sessions.sessions[0].name;
      }
    }

    async function loadImages() {
      const session = $('session').value;
      const res = await api('/api/v1/captures/images?session=' + encodeURIComponent(session));
      const box = $('images');
      box.innerHTML = '';
      currentImage = null;
      currentFilename = '';
      clearBoxes();
      $('img').src = '';

      await refreshAnnotationIndex();

      for (const img of res.images) {
        const div = document.createElement('div');
        div.className = 'item';
        div.textContent = img;
        if (labeledSet.has(img)) {
          div.style.opacity = '0.45';
        }
        div.onclick = async () => {
          [...box.querySelectorAll('.item')].forEach(x => x.classList.remove('active'));
          div.classList.add('active');
          await selectImage(session, img);
        };
        box.appendChild(div);
      }

      if (res.images.length) {
        box.firstChild.click();
      }
    }

    async function selectImage(session, filename) {
      clearBoxes();
      currentOcr = [];
      currentImage = `${session}/${filename}`;
      currentFilename = filename;
      $('img').src = '/api/v1/captures/image?path=' + encodeURIComponent(currentImage);
      setStatus('Loaded ' + currentImage + '. Loading OCR (cache-first)...');
      await runOcr();
    }

    async function runOcr() {
      if (!currentImage) { setStatus('Select an image first'); return; }
      const m = ($('vlm_model').value || '').trim();
      const url = '/api/v1/local_vlm/ocr?path=' + encodeURIComponent(currentImage) + '&model=' + encodeURIComponent(m);
      setStatus('Loading Local VLM OCR... (cache-first, first time downloads & loads model)');
      const data = await api(url);
      currentOcr = data.items || [];

      const img = $('img');
      await img.decode().catch(() => {});

      const scaleX = img.clientWidth / img.naturalWidth;
      const scaleY = img.clientHeight / img.naturalHeight;

      clearBoxes();
      for (const it of currentOcr) {
        addBox(it, scaleX, scaleY);
      }
      setStatus(`OCR boxes: ${currentOcr.length}. Fill label and click a box to save.`);
    }

    async function refreshAnnotationIndex() {
      const session = $('session').value;
      if (!session) { labeledSet = new Set(); return; }
      try {
        const idx = await api('/api/v1/annotations/index?session=' + encodeURIComponent(session));
        labeledSet = new Set(idx.labeled || []);
      } catch (e) {
        labeledSet = new Set();
      }
    }

    async function goNextUnlabeled() {
      const session = $('session').value;
      if (!session) { setStatus('Select a session first'); return; }
      const after = currentFilename || '';
      const res = await api('/api/v1/captures/next_unlabeled?session=' + encodeURIComponent(session) + '&after=' + encodeURIComponent(after));
      if (!res || !res.filename) {
        setStatus('All labeled in this session');
        return;
      }

      const list = $('images');
      const nodes = [...list.querySelectorAll('.item')];
      const node = nodes.find(n => (n.textContent || '') === res.filename);
      if (node) node.click();
      else await selectImage(session, res.filename);
    }

    async function buildOcrIndex() {
      const session = $('session').value;
      if (!session) { setStatus('Select a session first'); return; }
      const m = ($('vlm_model').value || '').trim();
      setStatus('Building local_vlm_ocr_index.jsonl from cache...');
      const url = '/api/v1/local_vlm/ocr_index/build?session=' + encodeURIComponent(session) + '&compute_missing=0&model=' + encodeURIComponent(m);
      const res = await api(url, { method: 'POST' });
      setStatus(`Built: ${res.out} (written=${res.written}, missing=${res.missing}, errors=${res.errors})`);
    }

    $('reload_sessions').onclick = async () => {
      try { await loadSessions(); await loadImages(); } catch (e) { setStatus(e.message); }
    };
    $('reload_images').onclick = async () => {
      try { await loadImages(); } catch (e) { setStatus(e.message); }
    };
    $('next_unlabeled').onclick = async () => {
      try { await goNextUnlabeled(); } catch (e) { setStatus(e.message); }
    };
    $('build_ocr_index').onclick = async () => {
      try { await buildOcrIndex(); } catch (e) { setStatus(e.message); }
    };

    (async () => {
      try {
        $('engine').value = 'local_vlm';
        $('vlm_model').value = 'Qwen/Qwen3-VL-8B-Instruct';

        await loadSessions();
        await loadImages();
        setStatus('Ready');
      } catch (e) {
        setStatus(e.message);
      }
    })();
  </script>
</body>
</html>
